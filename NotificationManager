-- open sourave notification manager not mines 
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local SoundService = game:GetService("SoundService")
local LocalPlayer = Players.LocalPlayer

if getgenv().NotificationManager then return getgenv().NotificationManager end

local parent = gethui and gethui() or LocalPlayer:WaitForChild("PlayerGui")
local existing = parent:FindFirstChild("__NotifManager")
if existing then existing:Destroy() end

getgenv()._NM_DEFAULT_SOUND    = 136001454409424
getgenv()._NM_MAX_VISIBLE      = 5
getgenv()._NM_DEFAULT_DURATION = 4
getgenv()._NM_notifCount       = 0
getgenv()._NM_queue            = {}
getgenv()._NM_active           = {}

local gui = Instance.new("ScreenGui")
gui.Name = "__NotifManager"
gui.IgnoreGuiInset = true
gui.ScreenInsets = Enum.ScreenInsets.DeviceSafeInsets
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.ResetOnSpawn = false
gui.DisplayOrder = 999
if syn and syn.protect_gui then syn.protect_gui(gui) end

local container = Instance.new("Frame")
container.Name = "Container"
container.BackgroundTransparency = 1
container.AnchorPoint = Vector2.new(1, 1)
container.Size = UDim2.new(0, 260, 1, -16)
container.Position = UDim2.new(1, -14, 1, -14)
container.ZIndex = 100
container.Parent = gui

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0, 5)
layout.VerticalAlignment = Enum.VerticalAlignment.Bottom
layout.FillDirection = Enum.FillDirection.Vertical
layout.Parent = container

gui.Parent = parent

local function playSound(id)
	local sid = id or getgenv()._NM_DEFAULT_SOUND
	if type(sid) ~= "number" and type(sid) ~= "string" then return end
	local s = Instance.new("Sound")
	s.SoundId = "rbxassetid://"..tostring(sid)
	s.Volume = 0.45
	s.Parent = SoundService
	s:Play()
	game:GetService("Debris"):AddItem(s, 4)
end

local function countActive()
	local n = 0
	for _ in pairs(getgenv()._NM_active) do n += 1 end
	return n
end

local function processQueue()
	while #getgenv()._NM_queue > 0 and countActive() < getgenv()._NM_MAX_VISIBLE do
		local next = table.remove(getgenv()._NM_queue, 1)
		next()
	end
end

local function dismissNotif(frame, onDone)
	if not frame or not frame.Parent then
		if onDone then onDone() end return
	end
	local info = TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In)
	TweenService:Create(frame, info, {
		Position = UDim2.new(1, 20, frame.Position.Y.Scale, frame.Position.Y.Offset),
		BackgroundTransparency = 1
	}):Play()
	for _, child in pairs(frame:GetDescendants()) do
		if child:IsA("TextLabel") then
			TweenService:Create(child, TweenInfo.new(0.15), {TextTransparency = 1}):Play()
		elseif child:IsA("Frame") then
			TweenService:Create(child, TweenInfo.new(0.2), {BackgroundTransparency = 1}):Play()
		elseif child:IsA("UIStroke") then
			TweenService:Create(child, TweenInfo.new(0.2), {Transparency = 1}):Play()
		end
	end
	task.delay(0.28, function()
		if frame then frame:Destroy() end
		if onDone then onDone() end
	end)
end

local function spawnNotif(title, message, accentColor, duration, soundId)
	getgenv()._NM_notifCount += 1
	local id = getgenv()._NM_notifCount
	local accent = accentColor or Color3.fromRGB(100, 100, 120)
	local dur = duration or getgenv()._NM_DEFAULT_DURATION

	local frame = Instance.new("Frame")
	frame.Name = "Notif_"..id
	frame.BackgroundColor3 = Color3.fromRGB(18, 18, 20)
	frame.BackgroundTransparency = 1
	frame.BorderSizePixel = 0
	frame.Size = UDim2.new(1, 0, 0, 56)
	frame.Position = UDim2.new(0.1, 0, 0, 0)
	frame.LayoutOrder = id
	frame.ClipsDescendants = false
	frame.Parent = container

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 7)
	corner.Parent = frame

	local border = Instance.new("UIStroke")
	border.Color = Color3.fromRGB(42, 42, 48)
	border.Thickness = 1
	border.Transparency = 1
	border.Parent = frame

	local accentBar = Instance.new("Frame")
	accentBar.BorderSizePixel = 0
	accentBar.BackgroundColor3 = accent
	accentBar.BackgroundTransparency = 1
	accentBar.Size = UDim2.new(0, 3, 0.58, 0)
	accentBar.Position = UDim2.new(0, 9, 0.21, 0)
	accentBar.Parent = frame
	local ac = Instance.new("UICorner") ac.CornerRadius = UDim.new(1, 0) ac.Parent = accentBar

	local titleLbl = Instance.new("TextLabel")
	titleLbl.Text = title
	titleLbl.TextColor3 = Color3.fromRGB(228, 228, 232)
	titleLbl.TextTransparency = 1
	titleLbl.BackgroundTransparency = 1
	titleLbl.BorderSizePixel = 0
	titleLbl.Size = UDim2.new(1, -26, 0, 20)
	titleLbl.Position = UDim2.new(0, 18, 0, 8)
	titleLbl.TextWrapped = true
	titleLbl.TextScaled = true
	titleLbl.Font = Enum.Font.GothamBold
	titleLbl.TextXAlignment = Enum.TextXAlignment.Left
	titleLbl.Parent = frame

	local descLbl = Instance.new("TextLabel")
	descLbl.Text = message
	descLbl.TextColor3 = Color3.fromRGB(130, 130, 142)
	descLbl.TextTransparency = 1
	descLbl.BackgroundTransparency = 1
	descLbl.BorderSizePixel = 0
	descLbl.Size = UDim2.new(1, -26, 0, 15)
	descLbl.Position = UDim2.new(0, 18, 0, 29)
	descLbl.TextWrapped = true
	descLbl.TextScaled = true
	descLbl.Font = Enum.Font.Gotham
	descLbl.TextXAlignment = Enum.TextXAlignment.Left
	descLbl.Parent = frame

	local trackBg = Instance.new("Frame")
	trackBg.BorderSizePixel = 0
	trackBg.BackgroundColor3 = Color3.fromRGB(36, 36, 42)
	trackBg.BackgroundTransparency = 1
	trackBg.Size = UDim2.new(1, -18, 0, 2)
	trackBg.Position = UDim2.new(0, 9, 1, -4)
	trackBg.Parent = frame
	local tc = Instance.new("UICorner") tc.CornerRadius = UDim.new(1, 0) tc.Parent = trackBg

	local trackFill = Instance.new("Frame")
	trackFill.BorderSizePixel = 0
	trackFill.BackgroundColor3 = accent
	trackFill.BackgroundTransparency = 1
	trackFill.Size = UDim2.new(1, 0, 1, 0)
	trackFill.Parent = trackBg
	local tfc = Instance.new("UICorner") tfc.CornerRadius = UDim.new(1, 0) tfc.Parent = trackFill

	getgenv()._NM_active[id] = frame

	local slideIn = TweenInfo.new(0.32, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
	local fadeIn  = TweenInfo.new(0.22, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

	TweenService:Create(frame, slideIn, {Position = UDim2.new(0, 0, 0, 0), BackgroundTransparency = 0}):Play()
	TweenService:Create(border, fadeIn, {Transparency = 0}):Play()
	TweenService:Create(accentBar, fadeIn, {BackgroundTransparency = 0}):Play()
	TweenService:Create(trackBg, fadeIn, {BackgroundTransparency = 0}):Play()
	TweenService:Create(trackFill, fadeIn, {BackgroundTransparency = 0}):Play()
	TweenService:Create(titleLbl, fadeIn, {TextTransparency = 0}):Play()
	TweenService:Create(descLbl, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {TextTransparency = 0}):Play()

	TweenService:Create(trackFill, TweenInfo.new(dur, Enum.EasingStyle.Linear), {Size = UDim2.new(0, 0, 1, 0)}):Play()

	playSound(soundId)

	task.delay(dur, function()
		getgenv()._NM_active[id] = nil
		dismissNotif(frame, processQueue)
	end)
end

local NotificationManager = {}

function NotificationManager.notify(title, message, color, duration, soundId)
	if type(title) ~= "string" or title == "" then return end
	if type(message) ~= "string" then message = "" end
	if color ~= nil and typeof(color) ~= "Color3" then color = nil end
	if duration ~= nil and type(duration) ~= "number" then duration = nil end
	if soundId ~= nil and type(soundId) ~= "number" then soundId = nil end
	if countActive() < getgenv()._NM_MAX_VISIBLE then
		spawnNotif(title, message, color, duration, soundId)
	else
		table.insert(getgenv()._NM_queue, function()
			spawnNotif(title, message, color, duration, soundId)
		end)
	end
end

function NotificationManager.dismissAll()
	for id, frame in pairs(getgenv()._NM_active) do
		getgenv()._NM_active[id] = nil
		dismissNotif(frame)
	end
	getgenv()._NM_queue = {}
end

function NotificationManager.setMaxVisible(n)
	if type(n) ~= "number" then return end
	getgenv()._NM_MAX_VISIBLE = math.clamp(math.floor(n), 1, 20)
end

function NotificationManager.setDefaultDuration(n)
	if type(n) ~= "number" then return end
	getgenv()._NM_DEFAULT_DURATION = math.max(n, 0.5)
end

function NotificationManager.setDefaultSound(id)
	if type(id) ~= "number" then return end
	getgenv()._NM_DEFAULT_SOUND = id
end

function NotificationManager.setPosition(pos)
	local valid = {bottomright=true, bottomleft=true, topright=true, topleft=true}
	if not valid[pos] then return end
	if pos == "bottomright" then
		container.AnchorPoint = Vector2.new(1,1)
		container.Position = UDim2.new(1,-14,1,-14)
		layout.VerticalAlignment = Enum.VerticalAlignment.Bottom
	elseif pos == "bottomleft" then
		container.AnchorPoint = Vector2.new(0,1)
		container.Position = UDim2.new(0,14,1,-14)
		layout.VerticalAlignment = Enum.VerticalAlignment.Bottom
	elseif pos == "topright" then
		container.AnchorPoint = Vector2.new(1,0)
		container.Position = UDim2.new(1,-14,0,14)
		layout.VerticalAlignment = Enum.VerticalAlignment.Top
	elseif pos == "topleft" then
		container.AnchorPoint = Vector2.new(0,0)
		container.Position = UDim2.new(0,14,0,14)
		layout.VerticalAlignment = Enum.VerticalAlignment.Top
	end
end

getgenv().NotificationManager = NotificationManager
return NotificationManager
